<html>
  <head>
    <link rel="apple-touch-icon" href="/inspiritas-bootstrap/images/apple-touch-icon.png" />
    <link rel="shortcut icon" href="/inspiritas-bootstrap/images/favicon.ico" />
    <link href="/inspiritas-bootstrap/bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="/inspiritas-bootstrap/inspiritas.css" rel="stylesheet" type="text/css" />

    <title>Your Time (URT.im) 9000, the friendly bot that track your time</title>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <script src="/inspiritas-bootstrap/bootstrap/js/bootstrap.min.js"></script>
    <script src="/inspiritas-bootstrap/js/moment.min.js"></script>

<script src="/socket.io/socket.io.js"></script>
<script>
  var user= null;

// counter punch in
  var start = moment();

  setInterval(function(){
    $("#counter").html(moment(start).fromNow());
  },1000);

  //var socket = io.connect('http://localhost');
  var socket = io.connect("/");
  socket.on('bot', function (data) {
    var id = data.id || "result";
    var reply = data.text || data;
    if (data.id) {
      $('#'+id).append("<div class='alert alert-success'>"+reply+"</div>");
      $("#cmd").val("");
    } else
      $('#result').prepend("<div class='alert alert-success'>"+reply+"</div>");
    console.log(data);
  });



// for knockout, everyone can authenticate. If the user doesn't exist, it creates one. Security first.
var authenticate = function (name) {
  user = name;
  $('.name').html(user);
  $('.auth').fadeIn("slow");
  $("#login").slideUp("slow");
  $(".authenticated").css("opacity","1");
  $('#cmd').focus();
  
};

var logout = function () {
  $("#login").slideDown("slow");
  $('.auth').hide();
  $(".authenticated").css("opacity","0.2");
  $('#signin-name').focus();
  createCookie("username","",-1);
  user = null;
}

jQuery(function($){

  user = readCookie("username");
  if (user == null) {
    logout();
  } else {
    authenticate(user);    
  }
  $(".alternate").hide();
  $("section#log").slideDown("slow");

  $("#logout").click(function() { logout();return false; });

  $('.brand img').css("height",200).css("width",200).animate ({height:32,width:32},"slow");
  $('.brand').hover(function(){
    $('.brand img').clearQueue().animate ({height:100,width:100});   
  },function(){
    $('.brand img').clearQueue().animate ({height:32,width:32});   
  }).click(function(){
    $('#result').prepend("<div id='hal9000' class='alert alert-block'><a class='close'>x</a>I'm sorry, Dave. I'm afraid I can't do that. <br/>This mission is too important for me to allow you to jeopardize it.<br/><iframe src='http://nodeknockout.com/iframe/tech-to-the-people' frameborder=0 scrolling=no allowtransparency=true width=115 height=25></iframe></div>");
    return false;
  });

  $(document).on("click","a.close",function(event){$(this).parent().fadeOut();});

  $('section#todo').on("switch",function(){
    $.post("/bot/do",{user:user,cmd:"todo"},function(data){
      var tpl= '<table class="table table-striped full-section table-hover"><thead><tr><th>number</th><th>Task</th><th>Action</th></tr></thead><tbody>'; // I so much should have used mustache
      data = $.parseJSON(data);
      $.each(data.tasks, function(index, value) { 
        tpl= tpl+"<tr id='task_"+index+"'><td>"+index+"</td><td>"+value+"</td><td><a class='btn btn-primary btn-small'>Punch in</a></td></tr>";
      });
      tpl= tpl + '</tbody></table>';
      $("#todo .content").html(tpl);
    });
  });

  $("aside a").click(function() {
    var section = this.id.slice(3); // go-{section}
    $("aside li").removeClass("selected");
    $(".alternate").slideUp("slow");
    $("section#"+section).slideDown("slow").trigger({type:"switch",section:section});
    $(this).parent().addClass("selected");
    return false;
  });
  $("#signin").submit(function(){
    var user=$("#signin-name").val();
    if (user == "")
      return false;
    $.ajax({
      url: "/user/connect",
      data:{user:user,bot:"web"},
      type: "post",
      success: function(data) {
        authenticate(user);   
        if ($("#remember-me").attr("checked"))
          console.log("remember");
        else
          console.log("do not remember");
        createCookie("username",user,7)  
        $('#result').append("<div class='alert alert-success'>"+data+"</div>");
      },
    });
    return false; 
  });



  $("#bot").submit(function(){
    var uniq = 'reply' + (new Date()).getTime();
    $('#result').prepend("<div id='"+uniq+"' class='alert alert-info'><a class='close'>x</a>"
      +$("#cmd").val()+"</div>");
    socket.emit('command', {user:user,cmd:$("#cmd").val(),id:uniq});
/*
    $.ajax({
      url: "/user/do",
      data:{user:user,cmd:$("#cmd").val()},
      type: "post",
      error: function(xhr,text){
        if (xhr.responseText) { text = xhr.responseText;}
        $('#'+uniq).append("<div class='alert alert-error'>"+text+"</div>");
      },
      success: function(data) {
        $('#'+uniq).append("<div class='alert alert-success'>"+data+"</div>");
        $("#cmd").val("");
      },
    });
*/
    return false;
  });
});

function createCookie(name,value,days) {
  if (days) {
    var date = new Date();
    date.setTime(date.getTime()+(days*24*60*60*1000));
    var expires = "; expires="+date.toGMTString();
  } else 
    var expires = "";
  document.cookie = name+"="+value+expires+"; path=/";
}

function readCookie(name) {
  var nameEQ = name + "=";
  var ca = document.cookie.split(';');
  for(var i=0;i < ca.length;i++) {
    var c = ca[i];
    while (c.charAt(0)==' ') c = c.substring(1,c.length);
      if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
    }
  return null;
}

</script>
  </head>
  <body>
<div class="navbar navbar-static-top navbar-inverse">
  <div class="navbar-inner">
    <div class="container">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>

      <div class="brand">
<img src="/inspiritas-bootstrap/images/apple-touch-icon.png" title="URT 9000" alt="URT.im 9000"/>UR <b>T</b>im<i>e</i>
      <span class="tagline">the friendly bot that tracks your time</span>
</div>

      <div class="nav-collapse collapse" id="main-menu">
        <div class="auth pull-right">
            <!--img class="avatar" src="images/littke.png"-->
            <span class="name">Tech To The People</span><br/>
            <span class="links">
                <a id="logout" href="">Logout</a>
            </span>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container">
    <div class="row-fluid">
        <div class="span3">
            <aside>
                <nav>
                    <ul class="nav">
                      <li class="selected">
                        <a id="go-log" href=""><i class="icon-eye-open icon-white"></i>Bot command</a>
                      </li>
                      <li>
                        <a id="go-todo" href=""><i class="icon-tasks icon-white"></i>TODO List</a>
                      </li>
                      <li>
                        <a id="go-timesheet" href=""><i class="icon-time icon-white"></i>Timesheet</a>
                      </li>
                      <li>
                        <a id="go-timeline" href=""><i class="icon-picture icon-white"></i>Timeline</a>
                      </li>
                      <li>
                        <a id="go-help" href=""><i class="icon-question-sign icon-white"></i>Help</a>
                      </li>
                    </ul>
                </nav>
            </aside>
        </div>
        <div class="span9" id="content-wrapper">
            <div id="content">
<section id="login">

                  <div class="row-fluid">
                    <div class="span6 well">
      <form class="form-signin" id="signin">
        <h2 class="form-signin-heading">Please sign in</h2>
        <input type="text" id="signin-name" class="input-block-level" title="for the nerds:that's your xmpp account" placeholder="chat address (email address on gmail)">
        <label class="checkbox">
          <input type="checkbox" id="remember-me"> Remember me
        </label>
        <button class="btn btn-large btn-primary" type="submit">Sign in</button>
      </form>
</div>
<div class="span6 alert alert-info">
<a class="close">x</a>
<p>You can give any address (even fake), but if you want the full experience of chating with the bot, you need to provide one that offers chat, like gmail.
</p>
<p>
We will not resell your contact details nor spam you in any way, shape or form.
</p>
<p>
<b>You can stop the test at any time by blocking the bot from your chat client</b>
</p>
</div>
</div>
</section>

               <section id="bot" class="authenticated">
                  <div class="sub-header">
                    <h1>The bot <span>punched you in </span> <span id="counter">a second ago</span></h1>

    <form id="bot" class="form-horizontal">
                  <div class="row-fluid well">
                    <div class="span10">


                          <div class="control-group">
      <label class="control-label" for="cmd">Command</label>
       <div class="controls">
        <input name="cmd" id="cmd" class="input-block-level span12"  placeholder="Type your command (or 'help')" />
       </div>
                          </div>
</div>
                    <div class="span2">
                        <button type="submit" class="btn btn-primary">Send</button>
                      </div>

</div>
    </form>
</section>
<section id="log" class="alternate authenticated">
                <div class="sub-header">
                  <h2>Results</h2>
                </div>

                <div class="row-fluid">
                    <div class="span12" id="result">
                    </div>
                </div>
              </section>
  
<section id="todo" class="alternate authenticated">
                <div class="sub-header">
                  <h2>TODO list</h2>
                </div>
                <div class="row-fluid">
                    <div class="span12">
<div id='tip-todo' class='alert alert-block'>
You can as well type the command <span class="command" data-cmd="todo">todo</span>.
</div>
<div class="content"></div>
                    </div>
                </div>
</section>

<section id="timesheet" class="alternate authenticated">
                <div class="sub-header">
                  <h2>Timesheet</h2>
                </div>
                <div class="row-fluid">
                    <div class="span12">
                    </div>
                </div>
</section>


<section id="timeline" class="alternate authenticated">
                <div class="sub-header">
                  <h2>Timeline</h2>
                </div>
                <div class="row-fluid">
                    <div class="span12">
                    </div>
                </div>
</section>


<section id="help" class="alternate">
                <div class="sub-header">
                  <h2>Help</h2>
                </div>
                <div class="row-fluid">
                    <div class="span12">
Coming soon
                    </div>
                </div>
</section>

              <section id="miscellaneous" style="display:none;">
                <div class="sub-header">
                  <h2>Alerts</h2>
                </div>

                <div class="row-fluid">
                    <div class="span12">
                        <div class="alert alert-block">
                          <a class="close">&times;</a>
                          <h4 class="alert-heading">Alert block</h4>
                          <p>Best check yo self, you're not looking too good. Nulla vitae elit libero, a pharetra augue. Praesent commodo cursus magna, vel scelerisque nisl consectetur et.</p>
                        </div>
                    </div>
                </div>
                <div class="row-fluid">
                  <div class="span4">
                    <div class="alert alert-error">
                      <a class="close">&times;</a>
                      <strong>Error</strong> Change a few things up and try submitting again.
                    </div>
                  </div>
                  <div class="span4">
                    <div class="alert alert-success">
                      <a class="close">&times;</a>
                      <strong>Success</strong> You successfully read this important alert message.
                    </div>
                  </div>
                  <div class="span4">
                    <div class="alert alert-info">
                      <a class="close">&times;</a>
                      <strong>Information</strong> This alert needs your attention, but it's not super important.
                    </div>
                  </div>
                </div>
            </section>

<!--iframe src="http://nodeknockout.com/iframe/tech-to-the-people" frameborder=0 scrolling=no allowtransparency=true width=115 height=25>
</iframe-->

            </div>
        </div>
    </div>

</div><!-- /container -->

  </body>
</html>
